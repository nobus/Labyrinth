<!DOCTYPE html>

<html lang='en'>

<head>
  <script src='http://code.jquery.com/jquery-1.11.3.min.js'></script>
  <!-- https://github.com/caleb531/jcanvas -->
  <script src='jcanvas.min.js'></script>

  <script>

    function GetURLParameter (sParam) {
      var sPageURL = decodeURIComponent(window.location.search.substring(1));
      var sURLVariables = sPageURL.split('&');
      var sParameterName;

      for (i = 0; i < sURLVariables.length; i++) {
        sParameterName = sURLVariables[i].split('=');

        if (sParameterName[0] === sParam) {
          return sParameterName[1] === undefined ? true : sParameterName[1];
        }
      }
    }

    function AddMessageToConsole (message) {
      var htmlString = $('#console').html() + message + '</br>';
      $('#console').html(htmlString);
    }

    function DrawMap (labMap) {
      for (var i = 0; i < labMap.length; i++) {
        var mapRow = labMap[i];

        for (var ii = 0; ii < mapRow.length; ii++) {
          var element = mapRow[ii];

          if (element === 1) {
            var colorStyle = '#000';
          } else if (element === 0) {
            var colorStyle = '#fff';
          }

          $('#labyrinth').drawRect({
            fillStyle: colorStyle,
            x: ii * 5,
            y: i * 5,
            width: 5,
            height: 5,
            fromCenter: false
          });
        }
      }
    }

    function ChangeMap(changeMap) {
      changeMap.forEach(function (item) {
        if (item.id === 1) {
          var colorStyle = '#000';
        } else if (item.id === 0) {
          var colorStyle = '#fff';
        }

        $('#labyrinth').drawRect({
          fillStyle: colorStyle,
          x: item.x * 5,
          y: item.y * 5,
          width: 5,
          height: 5,
          fromCenter: false
        });
      });
    }

    function ChangePosition(changePosition) {
      $('#labyrinth').drawRect({
        fillStyle: '#ff0000',
        y: changePosition.y * 5,
        x: changePosition.x * 5,
        width: 5,
        height: 5,
        fromCenter: false
      });

      if ('oldY' in changePosition && 'oldX' in changePosition) {
        $('#labyrinth').drawRect({
          fillStyle: '#fff',
          y: changePosition.oldY * 5,
          x: changePosition.oldX * 5,
          width: 5,
          height: 5,
          fromCenter: false
        });
      }
    }

    var login = GetURLParameter('login');
    var socket = new WebSocket('ws://localhost:8080/');

    socket.onopen = function() {
      socket.send(JSON.stringify({'login': login}));
      AddMessageToConsole('Connection done.');

      $(document).keypress(function (event) {
        if (socket) {
          var direction;

          if (event.keyCode === 119) {          // w
            direction = 'up';
          } else if (event.keyCode === 115) {   // s
            direction = 'down';
          } else if (event.keyCode === 97) {    // a
            direction = 'left';
          } else if (event.keyCode === 100) {   // d
            direction = 'right';
          }

          if (direction) {
            socket.send(JSON.stringify({'login': login, 'direction': direction}));
          }
        }

      });
    };

    socket.onclose = function(event) {
      if (event.wasClean) {
        AddMessageToConsole('Connection closed.');
      } else {
        AddMessageToConsole('Connection broken.'); // for example, server died
      }
      AddMessageToConsole('Code: ' + event.code + ' reason: ' + event.reason);
    };

    socket.onmessage = function(event) {
      var rawMessage = event.data;
      AddMessageToConsole('Data received: ' + rawMessage.length);
      var message = JSON.parse(rawMessage);

      if (message.allMap) {
        DrawMap(message.allMap);
      }

      if (message.changeMap) {
        ChangeMap(message.changeMap);
      }

      if (message.changePosition) {
        ChangePosition(message.changePosition);
      }
    };

    socket.onerror = function(error) {
      AddMessageToConsole('Error ' + error.message);
    };
  </script>
</head>

<body>
  Test client </br>

  <canvas id='labyrinth' width="500" height="500"></canvas> </br>

  <span id='console'></span>
</body>

</html>